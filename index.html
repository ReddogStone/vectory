<!DOCTYPE HTML>
<html>
<head>
	<meta charset="UTF-8"/>	
	<title>Vectory</title>
	<link rel="icon" href="data/vectory_icon.png" type="image/png">
	
	<script src="jabaku/math/Matrix3.js" type="text/javascript"></script>
	<script src="jabaku/math/Matrix4.js" type="text/javascript"></script>
	<script src="jabaku/math/Vector2.js" type="text/javascript"></script>
	<script src="jabaku/math/Vector3.js" type="text/javascript"></script>
	<script src="jabaku/math/Vector4.js" type="text/javascript"></script>
	<script src="jabaku/math/Quaternion.js" type="text/javascript"></script>
	<script src="jabaku/math/Ray.js" type="text/javascript"></script>
	<script src="jabaku/math/Mathutils.js" type="text/javascript"></script>

	<script src="jabaku/engine/webgl-debug.js" type="text/javascript"></script>
	<script src="jabaku/engine/utils.js" type="text/javascript"></script>
	<script src="jabaku/engine/fileutils.js" type="text/javascript"></script>
	<script src="jabaku/engine/webgl_utils.js" type="text/javascript"></script>
	<script src="jabaku/engine/engine3d.js" type="text/javascript"></script>
	<script src="jabaku/engine/mesh.js" type="text/javascript"></script>
	<script src="jabaku/engine/material.js" type="text/javascript"></script>
	<script src="jabaku/engine/scene.js" type="text/javascript"></script>
	<script src="jabaku/engine/color.js" type="text/javascript"></script>
	<script src="jabaku/engine/point_light.js" type="text/javascript"></script>
	<script src="jabaku/engine/camera.js" type="text/javascript"></script>
	<script src="jabaku/engine/texture_atlas.js" type="text/javascript"></script>

	<script src="jabaku/engine/id_container.js" type="text/javascript"></script>
	<script src="jabaku/engine/text_system.js" type="text/javascript"></script>
	<script src="jabaku/engine/geometry_system.js" type="text/javascript"></script>
	<script src="jabaku/engine/mesh_library.js" type="text/javascript"></script>

	<script src="jabaku/engine/renderables.js" type="text/javascript"></script>
	<script src="jabaku/engine/sprite_renderable.js" type="text/javascript"></script>
	<script src="jabaku/engine/text_renderable.js" type="text/javascript"></script>
	<script src="jabaku/engine/instanced_renderable.js" type="text/javascript"></script>
	<script src="jabaku/engine/transformable.js" type="text/javascript"></script>
	<script src="jabaku/engine/behaviors_updateable.js" type="text/javascript"></script>

	<script src="jabaku/profiler/profiler.js" type="text/javascript"></script>

	<script src="coord_plane.js" type="text/javascript"></script>
</head>
<body>
<canvas id="canvas" width="1024" height="768"></canvas>

<script>
	const BLUE = new Color(0.3, 0.5, 0.7);
	const PROFILER_LINES = 50;

	var g_canvas;
	var g_camEntity;
	var g_scene;
	var g_fpsLabel;
	var g_mousePosLabel;
	var lastTime = window.performance.now();
	var g_fps = 0;
	var g_frames = 0;
	var g_framesTime = 0;
	var g_mouse = {x: 0, y: 0, down: false};
	var g_viewport;
	var g_profileLines = [];

	var g_testCoordPlane;
	
	window.requestAnimFrame = (function () {
		return window.requestAnimationFrame ||
			window.webkitRequestAnimationFrame ||
			window.mozRequestAnimationFrame ||
			window.oRequestAnimationFrame ||
			window.msRequestAnimationFrame ||
			function(callback){
				window.setTimeout(callback, 1000 / 60);
			};
	}) ();
	
	function animate() {
		FrameProfiler.startFrame();
	
		var time = window.performance.now();
		var delta = (time - lastTime) * 0.001;
		lastTime = time;
		
		// update fps
		g_framesTime += delta;
		g_frames++;
		if (g_framesTime > 1.0) {
			g_framesTime -= 1.0;
			g_fps = g_frames;
			g_frames = 0;
		}

		var textSystem = g_scene.textSystem;

		textSystem.setText(g_fpsLabel.text, 'FPS: ' + g_fps);
		textSystem.setText(g_mousePosLabel.text, 'Mouse: (' +
			g_mouse.x + ', ' + g_mouse.y + ', ' + (g_mouse.down ? 'down': 'up') + ')');
		
		FrameProfiler.start('UpdateAll');
		g_camEntity.camera.rotateAroundTargetHoriz(g_camEntity.transformable, delta);
		FrameProfiler.stop();
		
		Engine3D.clear();
		
		FrameProfiler.start('RenderAll');
		FrameProfiler.stop();
		
		FrameProfiler.stopFrame();
		var lines = FrameProfiler.getReportStrings();
		g_profileLines.forEach(function(profileLine, index) {
			var text = lines[lines.length - 1 - index] || '';
			if (text) {
				profileLine.invisible = false;
				textSystem.setText(profileLine.text, text);
			} else {
				profileLine.invisible = true;
			}
		});
		
		g_scene.render(Engine3D, g_viewport, g_camEntity);
		
		requestAnimFrame( function() { animate(); } );
	}
	
    function extractMouseCoords(canvas, evt){
        // get canvas position
        var obj = canvas;
        var top = 0;
        var left = 0;
        while (obj && obj.tagName != 'BODY') {
            top += obj.offsetTop;
            left += obj.offsetLeft;
            obj = obj.offsetParent;
        }

        // return relative mouse position
        var mouseX = evt.clientX - left + window.pageXOffset;
        var mouseY = evt.clientY - top + window.pageYOffset;
        return {
            x: mouseX,
            y: mouseY
        };
    }

	var g_drag = {x: 0, y: 0};
	var g_click = false;
	
	function handleMouseEvent(event, isDown, type) {
		var coords = extractMouseCoords(canvas, event);
		g_mouse.x = coords.x;
		g_mouse.y = coords.y;
		g_mouse.down = isDown;
	}

	function handleMouseDown(event) {
		handleMouseEvent(event, true, 'mouseDown');
	}

	function handleMouseUp(event) {
		handleMouseEvent(event, false, 'mouseUp');
	}

	function handleMouseMove(event) {
		handleMouseEvent(event, g_mouse.down, 'mouseMove');
	}
	
	function handleKeyDown(event) {
	}
	function handleKeyPress(event) {
		if (event.keyCode == 120) { // F9
			FrameProfiler.toggle();
		}
	}
	function handleKeyUp(event) {
	}

	function start() {
		g_canvas = document.getElementById('canvas');
		
		Engine3D.init(g_canvas);
		Engine3D.setClearColor(new Color(0.1, 0.1, 0.1));
		
		Engine3D.createProgram('simple',
			FileUtils.loadFile('jabaku/shaders/simple.vshader'),
			FileUtils.loadFile('jabaku/shaders/simple.fshader'));
		Engine3D.createProgram('screenspace',
			FileUtils.loadFile('jabaku/shaders/screenspace.vshader'),
			FileUtils.loadFile('jabaku/shaders/screenspace.fshader'));
		Engine3D.createProgram('text',
			FileUtils.loadFile('jabaku/shaders/text.vshader'),
			FileUtils.loadFile('jabaku/shaders/screenspace.fshader'));
		Engine3D.createProgram('pointsprite',
			FileUtils.loadFile('jabaku/shaders/pointsprite.vshader'),
			FileUtils.loadFile('jabaku/shaders/screenspace.fshader'));
		Engine3D.createProgram('line',
			FileUtils.loadFile('jabaku/shaders/line.vshader'),
			FileUtils.loadFile('jabaku/shaders/screenspace.fshader'));
		Engine3D.createProgram('pointsprite_instanced',
			FileUtils.loadFile('jabaku/shaders/pointsprite_instanced.vshader'),
			FileUtils.loadFile('jabaku/shaders/screenspace_instanced.fshader'));
		Engine3D.createProgram('line_instanced',
			FileUtils.loadFile('jabaku/shaders/line_instanced.vshader'),
			FileUtils.loadFile('jabaku/shaders/screenspace_instanced.fshader'));

		Engine3D.createTextureFromFile('empty_texture', 'jabaku/data/empty_texture.png');
		Engine3D.createTextureFromFile('line_patterns', 'data/textures/line_patterns.png');
			
		g_viewport = new Viewport();
		
		g_camEntity = {
			camera: new Camera(0.5 * Math.PI, g_canvas.clientWidth / g_canvas.clientHeight, 0.01, 1000),
			transformable: new Transformable(new Vecmath.Vector3(0, 0, 10))
		};
		g_camEntity.camera.target = new Vecmath.Vector3(0, 0, 0);

		g_scene = new Scene(Engine3D);
		var textSystem = g_scene.textSystem;

		g_fpsLabel = {
			text: textSystem.addScreenText('', new Font('Georgia', 14), Color.white),
			transformable: new Transformable(new Vecmath.Vector3(10, 727, 0))
		};
		g_scene.addEntity(g_fpsLabel);

		for (var i = 0; i < PROFILER_LINES; ++i) {
			var profileLineLabel = {
				text: textSystem.addScreenText('', new Font('Lucida Console', 10), Color.white),
				transformable: new Transformable(new Vecmath.Vector3(10, i * 12, 0))
			};
			g_scene.addEntity(profileLineLabel);
			g_profileLines.push(profileLineLabel);
		}
				
		g_mousePosLabel = {
			text: textSystem.addScreenText('', new Font('Georgia', 14), Color.white),
			transformable: new Transformable(new Vecmath.Vector3(800, 727, 0))
		};
		g_scene.addEntity(g_mousePosLabel);
		g_scene.pointLight1 = new PointLight(new Vecmath.Vector3(0, 0, 10), new Color(1.0, 1.0, 1.0, 1.0));

		g_scene.addEntity({
			geometry: g_scene.geometrySystem.addQuad(
				new SimpleMaterial(Engine3D, null, g_scene.pointLight1.color, 1.0)),
			transformable: new Transformable(g_scene.pointLight1.pos, null, new Vecmath.Vector3(0.1, 0.1, 0.1))
		});
		g_scene.addEntity({
			geometry: g_scene.geometrySystem.addCube(
				new SimpleMaterial(Engine3D, null, Color.red, 0.0)),
			transformable: new Transformable(new Vecmath.Vector3(3, 3, 5), 
				null, new Vecmath.Vector3(2, 2, 2))
		});
		
		var material = new SimpleMaterial(Engine3D, null, new Color(1.0, 1.0, 1.0, 0.5), 0.0);
		material.blendMode = BlendMode.PREMUL_ALPHA;
		g_testCoordPlane = {
			geometry: g_scene.geometrySystem.addQuad(material),
			transformable: new Transformable(new Vecmath.Vector3(), 
				new Vecmath.Quaternion().setAxisAngle(new Vecmath.Vector3(1, 0, 0), 0.0 * Math.PI),
				new Vecmath.Vector3(10, 10, 10))
		};
		g_scene.addEntity(g_testCoordPlane);

		g_canvas.addEventListener('mousedown', handleMouseDown, false);
		g_canvas.addEventListener('mousemove', handleMouseMove, false);
		g_canvas.addEventListener('mouseup', handleMouseUp, false);
		
		document.onkeydown = handleKeyDown;
		document.onkeypress = handleKeyPress;
		document.onkeyup = handleKeyUp;
		
		requestAnimFrame(function() { animate(); });
	}
	
	start();
</script>
</body>
</html>